<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Fa√ßa seu Pedido</title>
    <style>
        /* Estilo "App de Comida" */
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #fff; color: #333; padding-bottom: 80px; }
        
        /* Cabe√ßalho */
        header { background-color: #e63946; color: white; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        h1 { margin: 0; font-size: 24px; }
        p { margin: 5px 0 0; opacity: 0.9; font-size: 14px; }

        /* Telas */
        .screen { display: none; padding: 20px; max-width: 600px; margin: 0 auto; animation: fadeIn 0.4s; }
        .screen.active { display: block; }

        /* Tela de Login */
        .login-box { text-align: center; margin-top: 50px; }
        input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #eee; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        input:focus { border-color: #e63946; outline: none; }
        
        /* Bot√£o Principal */
        .btn-primary { background-color: #e63946; color: white; border: none; padding: 15px; width: 100%; border-radius: 30px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(230, 57, 70, 0.3); transition: transform 0.2s; }
        .btn-primary:active { transform: scale(0.98); }

        /* Grid de Produtos */
        .menu-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .product-card { border: 1px solid #eee; border-radius: 15px; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .prod-info h3 { margin: 0 0 5px 0; font-size: 18px; color: #1d3557; }
        .prod-price { color: #2a9d8f; font-weight: bold; font-size: 16px; }
        .btn-add { background-color: #f1faee; color: #1d3557; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .btn-add:hover { background-color: #a8dadc; }

        /* Barra de Carrinho (Fundo) */
        .cart-bar { position: fixed; bottom: 0; left: 0; right: 0; background-color: white; padding: 15px 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; z-index: 200; }
        .cart-info span { display: block; font-size: 12px; color: #888; }
        .cart-total { font-size: 18px; font-weight: bold; color: #1d3557; }
        .btn-checkout { background-color: #2a9d8f; color: white; border: none; padding: 10px 25px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        .btn-checkout:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Modal de Resumo */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 300; }
        .modal { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; }
        .cart-list { max-height: 200px; overflow-y: auto; margin: 15px 0; border-top: 1px solid #eee; border-bottom: 1px solid #eee; padding: 10px 0; }
        .cart-item-row { display: flex; justify-content: space-between; margin-bottom: 8px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header>
        <h1>üçï Pizzaria Express</h1>
        <p>Seu pedido, do seu jeito.</p>
    </header>

    <div id="tela-login" class="screen active">
        <div class="login-box">
            <h2>üëã Bem-vindo!</h2>
            <p style="margin-bottom: 20px;">Para come√ßar, como podemos te chamar?</p>
            
            <input type="text" id="inputNome" placeholder="Seu Nome">
            <input type="tel" id="inputContato" placeholder="Seu WhatsApp / Telefone">
            
            <button class="btn-primary" onclick="iniciarAtendimento()">Ver Card√°pio</button>
        </div>
    </div>

    <div id="tela-cardapio" class="screen">
        <h2 style="margin-bottom: 20px;">O que vai pedir hoje? üòã</h2>
        <div id="lista-produtos" class="menu-grid">
            </div>
    </div>

    <div class="cart-bar" id="barra-carrinho" style="display: none;">
        <div class="cart-info">
            <span id="cart-count">0 itens</span>
            <div class="cart-total">R$ <span id="cart-total-display">0.00</span></div>
        </div>
        <button class="btn-checkout" id="btn-fechar" onclick="abrirResumo()" disabled>Concluir</button>
    </div>

    <div class="modal-overlay" id="modal-resumo">
        <div class="modal">
            <h2>Resumo do Pedido</h2>
            <p>Confira seus itens antes de pedir.</p>
            
            <div class="cart-list" id="lista-resumo"></div>
            
            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Pagamento:</label>
            <select id="formaPagamento" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                <option value="Pix">Pix</option>
                <option value="Dinheiro">Dinheiro</option>
                <option value="Cr√©dito">Cart√£o de Cr√©dito</option>
                <option value="D√©bito">Cart√£o de D√©bito</option>
            </select>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-primary" style="background-color: #ccc; color: #333;" onclick="fecharResumo()">Voltar</button>
                <button class="btn-primary" onclick="enviarPedido()">‚úÖ Enviar Pedido</button>
            </div>
        </div>
    </div>

    <script>
        const API = 'https://grumpy-rules-grin.loca.lt';
        
        // Estado do Cliente
        let usuario = { nome: '', contato: '' };
        let carrinho = [];
        let produtosCache = [];

        // --- PASSO 1: IDENTIFICA√á√ÉO ---
        function iniciarAtendimento() {
            const nome = document.getElementById('inputNome').value;
            const contato = document.getElementById('inputContato').value;

            if (!nome || !contato) {
                alert("Por favor, preencha seu nome e telefone.");
                return;
            }

            usuario.nome = nome;
            usuario.contato = contato;

            // Troca de tela
            document.getElementById('tela-login').classList.remove('active');
            document.getElementById('tela-cardapio').classList.add('active');
            document.getElementById('barra-carrinho').style.display = 'flex';

            carregarCardapio();
        }

        // --- PASSO 2: CARD√ÅPIO ---
        async function carregarCardapio() {
            try {
                const res = await fetch(`${API}/produtos`);
                produtosCache = await res.json();
                
                const container = document.getElementById('lista-produtos');
                container.innerHTML = produtosCache.map(p => `
                    <div class="product-card">
                        <div class="prod-info">
                            <h3>${p.nome}</h3>
                            <div class="prod-price">R$ ${p.preco.toFixed(2)}</div>
                        </div>
                        <button class="btn-add" onclick="adicionarItem(${p.id})">+</button>
                    </div>
                `).join('');
            } catch (err) {
                alert("Erro ao conectar com o servidor.");
            }
        }

        function adicionarItem(id) {
            const produto = produtosCache.find(p => p.id === id);
            
            // Verifica se j√° tem no carrinho
            const itemExistente = carrinho.find(item => item.produto.id === id);
            
            if (itemExistente) {
                itemExistente.quantidade++;
            } else {
                carrinho.push({ produto, quantidade: 1 });
            }

            atualizarCarrinhoUI();
            
            // Efeito visual de feedback
            alert(`+1 ${produto.nome} adicionado!`);
        }

        function atualizarCarrinhoUI() {
            const total = carrinho.reduce((acc, item) => acc + (item.produto.preco * item.quantidade), 0);
            const qtdItens = carrinho.reduce((acc, item) => acc + item.quantidade, 0);

            document.getElementById('cart-total-display').innerText = total.toFixed(2);
            document.getElementById('cart-count').innerText = `${qtdItens} itens`;
            
            document.getElementById('btn-fechar').disabled = carrinho.length === 0;
        }

        // --- PASSO 3: FINALIZA√á√ÉO ---
        function abrirResumo() {
            if(carrinho.length === 0) return;

            const lista = document.getElementById('lista-resumo');
            let html = '';
            carrinho.forEach(item => {
                html += `
                    <div class="cart-item-row">
                        <span>${item.quantidade}x ${item.produto.nome}</span>
                        <b>R$ ${(item.produto.preco * item.quantidade).toFixed(2)}</b>
                    </div>
                `;
            });
            // Adiciona total final
            const total = document.getElementById('cart-total-display').innerText;
            html += `<div style="text-align: right; font-weight: bold; margin-top: 10px; font-size: 18px;">Total: R$ ${total}</div>`;
            
            lista.innerHTML = html;
            document.getElementById('modal-resumo').style.display = 'flex';
        }

        function fecharResumo() {
            document.getElementById('modal-resumo').style.display = 'none';
        }

        async function enviarPedido() {
            // 1. Primeiro, cria/cadastra o cliente no banco silenciosamente
            // (Mesmo se ele j√° existir, o banco cria outro com novo ID ou poderiamos buscar, mas vamos simplificar criando sempre pra garantir o pedido)
            let clienteId = null;
            
            try {
                const resCli = await fetch(`${API}/clientes`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(usuario)
                });
                const clienteSalvo = await resCli.json();
                clienteId = clienteSalvo.id;
            } catch (e) {
                alert("Erro ao registrar cliente. Tente novamente.");
                return;
            }

            // 2. Com o ID do cliente, cria o pedido
            const payload = {
                clienteId: clienteId,
                total: document.getElementById('cart-total-display').innerText,
                formaPagamento: document.getElementById('formaPagamento').value,
                itens: carrinho.map(item => ({
                    produtoId: item.produto.id,
                    quantidade: item.quantidade
                }))
            };

            try {
                const resPed = await fetch(`${API}/pedidos`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                if (resPed.ok) {
                    const pedido = await resPed.json();
                    alert(`Pedido #${pedido.id} realizado com sucesso! Aguarde ser chamado.`);
                    window.location.reload(); // Reinicia o totem para o pr√≥ximo cliente
                } else {
                    alert("Ocorreu um erro ao enviar o pedido.");
                }
            } catch (e) {
                alert("Erro de conex√£o ao enviar pedido.");
            }
        }
    </script>
</body>
</html>